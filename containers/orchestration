#!/usr/bin/env bash

export COMMANDS="${PLAYBOOKS}/commands"
export TESTS="${PLAYBOOKS}/_tests"

# In several of the below functions, SITE is the result of SITENAME supporting
# a comma-separated list of sites. See functions/arguments file for details.

app_dev() {

  IDENTIFY_DRUPAL_TYPE=$(grep "${SITE}" "${CONTAINER_HTML_PATH}/.app-registry" | awk '{print $NF}' | tr --d '()')

  if [[ ${IDENTIFY_DRUPAL_TYPE} == 'BLT' ]]; then
    echo 'The app:dev command is not currently compatible with BLT. Exiting...'
    exit 0
  elif [[ ${IDENTIFY_DRUPAL_TYPE} == '' ]]; then
    echo 'Could not identify the application type. Exiting...'
  else
    echo -e "${BLUE}Configuring ${SITE} docroot for development...${COLOR_ENDING}"
    ${COMMANDS}/app-dev.yml --extra-vars "ansible_sudo_pass=${USER} app=dev sitename=${SITE}"
  fi
}

app_prod() {

  IDENTIFY_DRUPAL_TYPE=$(grep "${SITE}" "${CONTAINER_HTML_PATH}/.app-registry" | awk '{print $NF}' | tr --d '()')

  if [[ ${IDENTIFY_DRUPAL_TYPE} == 'BLT' ]]; then
    echo 'The app:prod command is not currently compatible with BLT. Exiting...'
    exit 0
  elif [[ ${IDENTIFY_DRUPAL_TYPE} == '' ]]; then
    echo 'Could not identify the application type. Exiting...'
  else
    echo -e "${BLUE}Configuring ${SITE} docroot for production...${COLOR_ENDING}"
    ${COMMANDS}/app-prod.yml --extra-vars "ansible_sudo_pass=${USER} app=prod sitename=${SITE}"
  fi
}

app_import() {
  app_delete

  echo -e "${BLUE}Importing app into new docroot ${SITE}...${COLOR_ENDING}"

  if [[ -d "${CONTAINER_IMPORT_PATH}/${SITE}/blt" ]]; then
    APP_DETECTED='BLT'
  elif [[ -f "${CONTAINER_IMPORT_PATH}/${SITE}/vendor/bin/lightning" ]]; then
    APP_DETECTED='Lightning'
  else
    APP_DETECTED='Drupal'
  fi

  ${COMMANDS}/app-import.yml --extra-vars "ansible_sudo_pass=${USER} app=${APP_DETECTED} sitename=${SITE}"
  hosts_file
}

app_drupal() {
  app_delete

  if [[ -z "${GIT_TAG}" ]]; then
    echo -e "${BLUE}Installing Drupal into new ${SITE} docroot...${COLOR_ENDING}"
    ${COMMANDS}/app-drupal.yml --extra-vars "ansible_sudo_pass=${USER} app=Drupal sitename=${SITE}"
    hosts_file
  elif [[ -n "${GIT_TAG}" ]]; then
    echo -e "${BLUE}Installing Drupal ${GIT_TAG} into new ${SITE} docroot...${COLOR_ENDING}"
    ${COMMANDS}/app-drupal.yml --extra-vars "ansible_sudo_pass=${USER} app=Drupal sitename=${SITE} git_tag=${GIT_TAG}"
    hosts_file
  fi
}

app_blt() {
  app_delete

  echo -e "${BLUE}Installing BLT into new ${SITE} docroot...${COLOR_ENDING}"
  ${COMMANDS}/app-blt.yml --extra-vars "ansible_sudo_pass=${USER} app=BLT sitename=${SITE}"
  hosts_file
}

app_lightning() {
  app_delete

  echo -e "${BLUE}Installing Lightning into new ${SITE} docroot...${COLOR_ENDING}"
  ${COMMANDS}/app-lightning.yml --extra-vars "ansible_sudo_pass=${USER} app=Lightning sitename=${SITE}"
  hosts_file
}

app_reservoir() {
  echo "Installing Reservoir on PHP ${DEFAULT_PHP} is currently broken."
  exit 0

  app_delete

  echo -e "${BLUE}Installing Reservoir into new ${SITE} docroot...${COLOR_ENDING}"
  ${COMMANDS}/app-reservoir.yml --extra-vars "ansible_sudo_pass=${USER} app=Reservoir sitename=${SITE}"
  hosts_file
}

set_previous_php_version() {
  echo -e "${BLUE}Switch to ${PREVIOUS_PHP}...${COLOR_ENDING}"
  ${COMMANDS}/previous-php.yml --extra-vars "ansible_sudo_pass=${USER}"
}

set_default_php_version() {
  echo -e "${BLUE}Switch to ${DEFAULT_PHP}...${COLOR_ENDING}"
  ${COMMANDS}/default-php.yml --extra-vars "ansible_sudo_pass=${USER}"
}
